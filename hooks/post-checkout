#!/bin/bash
set -euo pipefail

source="${BUILDKITE_PLUGIN_TOOL_VERSIONS_ENV_SOURCE:-asdf}"

while IFS='=' read -r name _ ; do
   if [[ $name =~ ^(BUILDKITE_PLUGIN_TOOL_VERSIONS_ENV_TOOLS_[0-9]+) ]]; then
       case "$source" in
           asdf)
               vsn="$(awk "/$name / {print \$2}" .tool-versions)"
               ;;
           mise)
               # We rashly assume it's a tool and not an env!
               vsn="$(awk "/$name = / {print \$3}" .mise.toml | tr -d '"')"
       esac

       #shellcheck disable=SC2046
       export $(tr '[:lower:]' '[:upper:]' <<< "$name")_VERSION="$vsn"
   fi
done < <(env | sort)
